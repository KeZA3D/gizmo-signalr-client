<!doctype html>
<html lang="en" class="h-100">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#7952b3">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <title>SignalR Example</title>
</head>

<body class="h-100 text-center text-white bg-dark">
    <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
        <header class="mb-auto">
            <div>
                <h3 class="float-md-start mb-0">Gizmo SignalR Example</h3>
            </div>
        </header>

        <main class="container-fluid">
            <div class="alert alert-danger" id="signalr-connection-state" role="alert">
                SignalR: not connected!
            </div>
            <div class="row justify-content-between">
                <div class="col-lg-4">
                    <div class="card">
                        <h5 class="card-header bg-dark">Create</h5>
                        <div class="card-body text-start text-dark overflow-auto"
                            style="min-height: 600px; max-height: 600px;" id="create-event-history">
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <h5 class="card-header bg-dark">Change</h5>
                        <div class="card-body text-start text-dark overflow-auto"
                            style="min-height: 600px; max-height: 600px;" id="change-event-history">
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <h5 class="card-header bg-dark ">Delete</h5>
                        <div class="card-body text-start text-dark overflow-auto"
                            style="min-height: 600px; max-height: 600px;" id="delete-event-history">
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="mt-auto text-white-50">
            <p>Powered by Alex <a href="https://github.com/KeZA3D" class="text-white">github</a>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>

    <!-- SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.7/signalr.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            //Global Variables
            var a, b, c, d, e, i, o;
            var signalrState = 0;
            var signalrCreateCard = document.getElementById("create-event-history"),
                signalrChangeCard = document.getElementById("change-event-history"),
                signalrDeleteCard = document.getElementById("delete-event-history"),
                signalrConnectionAlert = document.getElementById("signalr-connection-state");


            //Gizmo SignalR support only one method
            const EVENT = "EntityEvent";

            //Change this
            const HOST = "localhost:8080"

            const connection = new signalR.HubConnectionBuilder()
                .configureLogging(signalR.LogLevel.Debug)
                .withUrl("http://" + HOST + "/api/events", {
                    skipNegotiation: true, //Set "true" if you have negotiation troubles
                    transport: signalR.HttpTransportType.WebSockets
                })
                .build();


            async function start() {
                try {
                    await connection.start();
                    console.log("SignalR Connected.");
                    signalrConnectionAlert.classList.add("alert-success")
                    signalrConnectionAlert.classList.remove("alert-danger")
                    signalrConnectionAlert.innerHTML = "SignalR: connected!"
                    setTimeout(function () {
                        signalrConnectionAlert.classList.add("d-none")
                    }, 2000)

                    connection.on(EVENT, onmessage)
                } catch (err) {
                    console.log(err);
                    signalrConnectionAlert.classList.remove("alert-success")
                    signalrConnectionAlert.classList.add("alert-danger")
                    signalrConnectionAlert.innerHTML = "SignalR: not connected!"
                    signalrConnectionAlert.classList.remove("d-none")
                    setTimeout(start, 5000);
                }
            };

            connection.onclose(async () => {
                await start();
            });

            function onmessage(msg) {
                console.log(msg)
                switch (msg.Event.EventType) {
                    case 0:
                        signalrCreateCard.innerHTML = signalrCreateCard.innerHTML + toHTML(msg)
                        gotoBottom(signalrCreateCard)
                        break;
                    case 1:
                        signalrDeleteCard.innerHTML = signalrDeleteCard.innerHTML + toHTML(msg)
                        gotoBottom(signalrDeleteCard)
                        break;
                    case 2:
                        signalrChangeCard.innerHTML = signalrChangeCard.innerHTML + toHTML(msg)
                        gotoBottom(signalrChangeCard)
                        break;
                }
            }

            function toHTML(msg) {
                return '<p class="card-text"><b>' + msg.Event.EntityType + ':</b> ' + msg.Event.EntityId + ' </p>'
            }

            function gotoBottom(element) {
                element.scrollTop = element.scrollHeight - element.clientHeight;
            }

            // Start the connection.
            start();
        });
    </script>

</body>

</html>